<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YOK × FRONGZ — คำนวณค่าใช้จ่าย</title>
  <meta name="theme-color" content="#0b1020" />
  <!-- PWA manifest will be injected dynamically -->
  <link id="pwa-manifest" rel="manifest" href="#" />
  <link id="apple-touch" rel="apple-touch-icon" href="#" />
  <style>
    :root{
      --bg:#0b1020;--panel:#12182b;--soft:#1a2240;--text:#e6f0ff;--muted:#b7c4e0;--acc:#6ae3ff;--danger:#ff7a93;--ok:#8af78d
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#0a0f1a);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:20px}
    h1{font-size:clamp(20px,4vw,30px);margin:0 0 12px}
    p.lead{color:var(--muted);margin-top:4px}
    .card{background:var(--panel);border:1px solid #1f2949;border-radius:16px;box-shadow:0 10px 35px rgba(0,0,0,.35);padding:16px}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .grid.cols-4{grid-template-columns:repeat(4,1fr)}
    label{font-size:13px;color:var(--muted)}
    input[type="text"],input[type="number"],select{width:100%;padding:12px 12px;border-radius:12px;border:1px solid #273055;background:var(--soft);color:var(--text)}
    input[type="checkbox"]{transform:scale(1.2)}
    .row{display:flex;gap:10px;align-items:center}
    .btn{appearance:none;border:none;border-radius:12px;padding:12px 16px;cursor:pointer;background:#24305a;color:var(--text);transition:.15s}
    .btn:hover{filter:brightness(1.08)}
    .btn.acc{background:linear-gradient(135deg,#1fbef0,var(--acc))}
    .btn.ghost{background:transparent;border:1px solid #2c375f}
    .btn.danger{background:linear-gradient(135deg,#ff6a86,var(--danger))}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px}
    thead th{position:sticky;top:0;background:rgba(18,24,43,.9);backdrop-filter:blur(6px)}
    th,td{padding:10px;border-bottom:1px solid #25305a;text-align:left;font-size:14px}
    tbody tr:hover{background:#0f1630}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid #33406e}
    .pill.ok{border-color:#2d6f4f}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .summary{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .summary .box{background:var(--soft);border:1px solid #28325a;border-radius:12px;padding:12px}
    .mono{font-variant-numeric:tabular-nums}
    @media (max-width:720px){.grid.cols-4,.grid.cols-3{grid-template-columns:1fr 1fr}.summary{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>YOK × FRONGZ — คำนวณค่าใช้จ่าย</h1>
    <p class="lead">เพิ่มรายการค่าใช้จ่ายในช่องด้านล่าง พร้อมระบุยอดรายคน </p>

    <!-- Cloud Sync (Firebase) -->
    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between;gap:8px;flex-wrap:wrap">
        <div class="row" style="gap:8px">
          <label for="roomId">ซิงก์ออนไลน์ (ใส่รหัสห้องเดียวกัน):</label>
          <input id="roomId" type="text" placeholder="เช่น YOK-FRZ-001" style="min-width:220px" />
          <button id="connectBtn" class="btn acc">เชื่อมต่อ</button>
          <button id="disconnectBtn" class="btn ghost">ตัดการเชื่อมต่อ</button>
        </div>
        <div class="muted">สถานะ: <span id="cloudStatus">ออฟไลน์ (บันทึกในเครื่อง)</span></div>
      </div>
      <p class="muted" style="margin:10px 0 0">*ต้องตั้งค่า <code>window.FB_CONFIG</code> ของ Firebase ก่อนใช้รหัสห้องเดียวกันคือ YOK-FRZ-001จะเห็นร่วมกันแบบเรียลไทม์</p>
    </div>

    <div class="card" id="formCard">
      <div class="grid cols-4">
        <div>
          <label>รายการ</label>
          <input id="desc" type="text" placeholder="เช่น อาหารกลางวัน / ของใช้ในบ้าน" />
        </div>
        <div>
          <label>จำนวนเงิน (บาท)</label>
          <input id="amount" type="number" placeholder="0.00" step="0.01" min="0" />
        </div>
        <div>
          <label>จ่ายก่อนโดย</label>
          <select id="payer">
            <option value="YOK">YOK</option>
            <option value="FRONGZ">FRONGZ</option>
          </select>
       </div>
        <div>
          <label>การแบ่ง</label>
          <select id="splitMode">
            <option value="half">หารครึ่ง</option>
            <option value="charge">เรียกเก็บ</option>
            <option value="none">ไม่หาร</option>
          </select>
        </div>
      </div>
          <button id="addBtn" class="btn acc">เพิ่มรายการ</button>
        </div>
      </div>
      <div class="row" style="margin-top:10px;gap:8px">
        <button id="exportBtn" class="btn ghost">ส่งออก</button>
        <label class="btn ghost" style="position:relative;overflow:hidden">
          นำเข้า
          <input id="importFile" type="file" accept="application/json" style="position:absolute;inset:0;opacity:0;cursor:pointer" />
        </label>
        <button id="resetBtn" class="btn danger">ลบทั้งหมด</button>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <table>
        <thead>
          <tr>
            <th style="width:120px">วันที่</th>
            <th>รายการ</th>
            <th>จ่ายโดย</th>
            <th class="right">จำนวน</th>
            <th style="width:80px">หารครึ่ง</th>
            <th style="width:160px">จัดการ</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
        <tfoot>
          <tr>
            <td colspan="6" class="muted">* การคำนวณการโอน-รับเงิน จะพิจารณาเฉพาะรายการที่ติ๊ก "หารครึ่ง" เท่านั้น</td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="card" style="margin-top:16px">
      <h2 style="margin:0 0 8px">สรุปผล</h2>
      <div class="summary">
        <div class="box">
          <div class="row" style="justify-content:space-between"><span>จำนวนรายการ</span><strong class="mono" id="count"></strong></div>
          <hr style="border:0;border-top:1px solid #2a3460">
          <div class="row" style="justify-content:space-between"><span>YOK จ่ายทั้งหมด</span><strong class="mono" id="yPaid"></strong></div>
          <div class="row" style="justify-content:space-between"><span>FRONGZ จ่ายทั้งหมด</span><strong class="mono" id="fPaid"></strong></div>
        </div>
        <div class="box">
          <div class="row" style="justify-content:space-between"><span>ส่วนที่ YOK ต้องหาร</span><strong class="mono" id="yShare"></strong></div>
          <div class="row" style="justify-content:space-between"><span>ส่วนที่ FRONGZ ต้องหาร</span><strong class="mono" id="fShare"></strong></div>
          <hr style="border:0;border-top:1px solid #2a3460">
          <div class="row" style="justify-content:space-between"><span>สุทธิ YOK (ยอดที่ต้องจ่ายเพิ่ม)</span><strong class="mono" id="yNet"></strong></div>
          <div class="row" style="justify-content:space-between"><span>สุทธิ FRONGZ</span><strong class="mono" id="fNet"></strong></div>
        </div>
      </div>
      <div class="card" style="margin-top:12px;background:#0f1630;border-color:#26315b">
        <div id="settle" style="font-size:15px"></div>
      </div>
    </div>

    <p class="muted" style="margin-top:14px">ข้อมูลถูกบันทึกอัตโนมัติในเครื่อง (localStorage) — สามารถส่งออกไฟล์เพื่อเก็บ/แชร์ข้ามเครื่องได้</p>
  </div>

  <script>
  // ===== Utilities =====
  const fmt = new Intl.NumberFormat('th-TH', { style:'currency', currency:'THB', minimumFractionDigits:2 });
  const byId = (id)=>document.getElementById(id);
  const LS_KEY = 'yok-frongz-split-v1';

  /** Convert float money -> satang integer to avoid FP errors */
  const toSatang = (v)=> Math.round(Number(v)*100);
  const fromSatang = (s)=> (s/100);

  // ===== State =====
  let items = []; // {id, ts, desc, amountSatang, payer, split}
  let editingId = null;

  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(items)); }
  function load(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(raw){ items = JSON.parse(raw); }
    }catch(e){ console.error(e); items=[] }
  }

  // ===== Rendering =====
  function render(){
    const tbody = byId('tbody');
    tbody.innerHTML = '';

    let count = items.length;
    let totals = {
      YOK:{ paid:0, splitPaid:0, share:0 },
      FRONGZ:{ paid:0, splitPaid:0, share:0 }
    };

    for(const it of items){
      const tr = document.createElement('tr');
      const date = new Date(it.ts);
      const d = date.toLocaleDateString('th-TH', { year:'2-digit', month:'2-digit', day:'2-digit' });

      tr.innerHTML = `
        <td class="mono">${d}</td>
        <td>${escapeHtml(it.desc || '')}</td>
        <td><span class="pill">${it.payer}</span></td>
        <td class="right mono">${fmt.format(fromSatang(it.amountSatang))}</td>
        <td>${it.split? '<span class="pill ok">หาร</span>':'<span class="pill">ไม่หาร</span>'}</td>
        <td>
          <button class="btn ghost" onclick="onEdit('${it.id}')">แก้ไข</button>
          <button class="btn danger" onclick="onDelete('${it.id}')">ลบ</button>
        </td>`;
      tbody.appendChild(tr);

      // Accumulate totals
      totals[it.payer].paid += it.amountSatang;
      if(it.split){
        totals[it.payer].splitPaid += it.amountSatang;
        totals.YOK.share += Math.round(it.amountSatang/2);
        totals.FRONGZ.share += Math.round(it.amountSatang/2);
      }
    }

    // Compute nets (only split items)
    const yNetSatang = totals.YOK.splitPaid - totals.YOK.share;
    const fNetSatang = totals.FRONGZ.splitPaid - totals.FRONGZ.share;

    // Fill summary
    byId('count').textContent = count;
    byId('yPaid').textContent = fmt.format(fromSatang(totals.YOK.paid));
    byId('fPaid').textContent = fmt.format(fromSatang(totals.FRONGZ.paid));
    byId('yShare').textContent = fmt.format(fromSatang(totals.YOK.share));
    byId('fShare').textContent = fmt.format(fromSatang(totals.FRONGZ.share));
    byId('yNet').textContent = fmt.format(fromSatang(yNetSatang));
    byId('fNet').textContent = fmt.format(fromSatang(fNetSatang));

    // Settlement sentence
    const settle = byId('settle');
    let text = '';
    if(Math.abs(yNetSatang + fNetSatang) > 1){
      // Should be near 0; if not, force reconcile message
      text = '⚠️ มีข้อผิดพลาดในการคำนวณ โปรดลองรีเฟรชหรือตรวจสอบจำนวนเงิน';
    } else if (yNetSatang > 0) {
      text = `สรุป: FRONGZ ควรโอนให้ YOK <strong class="mono">${fmt.format(fromSatang(yNetSatang))}</strong> ตามยอดปัจจุบัน`;
    } else if (yNetSatang < 0) {
      text = `สรุป: YOK ควรโอนให้ FRONGZ <strong class="mono">${fmt.format(fromSatang(-yNetSatang))}</strong> ตามยอดปัจจุบัน`;
    } else {
      text = 'สรุป: เสมอกัน ไม่ต้องโอนเพิ่ม ✅';
    }
    settle.innerHTML = text;

    save();
  }

  // ===== Actions =====
  function addOrUpdate(){
  const desc = byId('desc').value.trim();
  const amountStr = byId('amount').value;
  const payer = byId('payer').value;
  const splitMode = byId('splitMode').value; // ✅ ใช้ค่าจาก select

  const amt = Number(amountStr);
  if(!desc){ alert('กรอกรายการก่อนนะ'); return }
  if(!isFinite(amt) || amt <= 0){ alert('จำนวนเงินไม่ถูกต้อง'); return }
  const amountSatang = toSatang(amt);

  if(editingId){
    const idx = items.findIndex(x=>x.id===editingId);
    if(idx>-1){ items[idx] = { ...items[idx], desc, amountSatang, payer, splitMode } }
    editingId = null;
    byId('addBtn').textContent = 'เพิ่มรายการ';
  } else {
    items.push({ id: crypto.randomUUID(), ts: Date.now(), desc, amountSatang, payer, splitMode });
  }

  // reset form
  byId('desc').value = '';
  byId('amount').value = '';
  byId('payer').value = 'YOK';
  byId('splitMode').value = 'half'; // ตั้งกลับเป็น “หารครึ่ง”

  render();
}

  function onEdit(id){
    const it = items.find(x=>x.id===id);
    if(!it) return;
    byId('desc').value = it.desc;
    byId('amount').value = fromSatang(it.amountSatang).toFixed(2);
    byId('payer').value = it.payer;
    byId('split').checked = !!it.split;
    editingId = id;
    byId('addBtn').textContent = 'บันทึกการแก้ไข';
    window.scrollTo({top:0,behavior:'smooth'});
  }

  function onDelete(id){
    if(!confirm('ลบรายการนี้?')) return;
    items = items.filter(x=>x.id!==id);
    render();
  }

  function resetAll(){
    if(!confirm('ลบรายการทั้งหมด?')) return;
    items = [];
    render();
  }

  function exportJson(){
    const blob = new Blob([JSON.stringify(items,null,2)],{type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'yok-frongz-split.json'; a.click();
    URL.revokeObjectURL(url);
  }

  function importJson(file){
    const reader = new FileReader();
    reader.onload = (e)=>{
      try{
        const data = JSON.parse(e.target.result);
        if(!Array.isArray(data)) throw new Error('format');
        // basic sanitize
        items = data.map(it=>({
          id: it.id || crypto.randomUUID(),
          ts: typeof it.ts==='number'? it.ts : Date.now(),
          desc: String(it.desc||''),
          amountSatang: toSatang(Number((it.amountSatang!=null)? fromSatang(it.amountSatang): it.amount)),
          payer: (it.payer==='FRONGZ')? 'FRONGZ':'YOK',
          split: !!it.split
        }));
        render();
      }catch(err){ alert('ไฟล์ไม่ถูกต้อง'); }
    };
    reader.readAsText(file);
  }

  function escapeHtml(str){
    return str.replace(/[&<>"]/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[s]));
  }

  // ===== Bindings =====
  byId('addBtn').addEventListener('click', addOrUpdate);
  byId('resetBtn').addEventListener('click', resetAll);
  byId('exportBtn').addEventListener('click', exportJson);
  byId('importFile').addEventListener('change', (e)=>{
    const f=e.target.files?.[0]; if(f) importJson(f);
    e.target.value='';
  });

  // Init
  load();
  render();
  </script>

  <!-- Firebase Cloud Sync (optional) -->
  <script type="module">
    // ========= Firebase (CDN v9 modular) =========
    import { initializeApp, getApps, getApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getFirestore, doc, onSnapshot, setDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

    // Put your Firebase config here, e.g. in a separate inline script:
    // <script>window.FB_CONFIG={ apiKey:'...', authDomain:'...', projectId:'...', appId:'...' }<\/script>
    const FB_CONFIG = window.FB_CONFIG || null;

    const cloud = { connected:false, roomId:null, db:null, unsub:null, updatingFromCloud:false };
    const $ = (id)=>document.getElementById(id);

    function initFirebase(){
      if(!FB_CONFIG){ alert('ยังไม่ได้ตั้งค่า window.FB_CONFIG ของ Firebase'); return null; }
      const app = getApps().length? getApp() : initializeApp(FB_CONFIG);
      return getFirestore(app);
    }

    async function connectRoom(){
      const rid = ($('#roomId').value||'').trim();
      if(!rid){ alert('กรอกรหัสห้องก่อน'); return; }
      const db = initFirebase(); if(!db) return;
      // Unsub previous
      if(cloud.unsub){ cloud.unsub(); cloud.unsub=null; }
      cloud.db = db; cloud.roomId = rid; cloud.connected = true;

      const ref = doc(db, 'rooms', rid);
      cloud.unsub = onSnapshot(ref, (snap)=>{
        const data = snap.exists()? snap.data(): null;
        if(data && Array.isArray(data.items)){
          cloud.updatingFromCloud = true;
          try{
            // Replace items then render
            items = data.items;
            render();
          } finally {
            cloud.updatingFromCloud = false;
          }
        }
        updateCloudStatus();
      }, (err)=>{
        console.warn('onSnapshot error', err);
        updateCloudStatus('error');
      });

      updateCloudStatus();
      // Push current local data to cloud (creates doc if missing)
      await pushToCloud();
    }

    function disconnectRoom(){
      if(cloud.unsub){ cloud.unsub(); cloud.unsub=null; }
      cloud.connected=false; cloud.roomId=null; cloud.db=null;
      updateCloudStatus();
    }

    async function pushToCloud(){
      if(!cloud.connected || cloud.updatingFromCloud) return;
      try{
        const ref = doc(cloud.db, 'rooms', cloud.roomId);
        await setDoc(ref, { items }, { merge:true });
      }catch(err){ console.warn('pushToCloud failed', err); }
    }

    function updateCloudStatus(state){
      const el = $('#cloudStatus');
      if(state==='error'){ el.textContent = 'ผิดพลาด: เชื่อมต่อไม่ได้'; return; }
      el.textContent = cloud.connected ? `ออนไลน์: ห้อง ${cloud.roomId}` : 'ออฟไลน์ (บันทึกในเครื่อง)';
    }

    // Bind buttons
    $('#connectBtn').addEventListener('click', connectRoom);
    $('#disconnectBtn').addEventListener('click', disconnectRoom);

    // Hook into existing save() to also push to cloud
    const _saveOrig = save;
    window.save = function(){
      _saveOrig();
      // Debounce push to cloud a bit
      clearTimeout(window.__pushTimer);
      window.__pushTimer = setTimeout(pushToCloud, 200);
    }
  </script>

  <script>
    // ===== PWA (Progressive Web App) bootstrap =====
    (function(){
      const isSecure = location.protocol.startsWith('http'); // HTTPS or http://localhost
      if(!isSecure){
        console.info('PWA disabled on file://; host on GitHub Pages or localhost to enable installable app.');
        return; // still works as a normal web app
      }

      // 1) Generate icon PNGs dynamically so we don't need external files
      function makeIcon(size){
        const c = document.createElement('canvas'); c.width = c.height = size; const g=c.getContext('2d');
        // bg gradient
        const grd = g.createLinearGradient(0,0,size,size);
        grd.addColorStop(0,'#0b1020'); grd.addColorStop(1,'#1a2240');
        g.fillStyle = grd; g.fillRect(0,0,size,size);
        // ring
        g.strokeStyle = '#6ae3ff'; g.lineWidth = Math.max(6, size*0.04); g.strokeRect(g.lineWidth, g.lineWidth, size-2*g.lineWidth, size-2*g.lineWidth);
        // text YF
        g.fillStyle = '#e6f0ff';
        g.font = `bold ${Math.floor(size*0.42)}px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial`;
        g.textAlign = 'center'; g.textBaseline = 'middle';
        g.fillText('YF', size/2, size/2+size*0.02);
        return c.toDataURL('image/png');
      }
      const icon192 = makeIcon(192);
      const icon512 = makeIcon(512);

      // 2) Create and attach manifest.json dynamically
      const manifest = {
        name: 'YOK × FRONGZ — ค่าใช้จ่าย & หารกัน',
        short_name: 'YF Split',
        description: 'บันทึกค่าใช้จ่ายของ YOK และ FRONGZ พร้อมคำนวณว่าใครติดหนี้ใคร',
        start_url: '.',
        scope: '.',
        display: 'standalone',
        background_color: '#0b1020',
        theme_color: '#0b1020',
        icons: [
          { src: icon192, sizes: '192x192', type: 'image/png', purpose: 'any maskable' },
          { src: icon512, sizes: '512x512', type: 'image/png', purpose: 'any maskable' }
        ]
      };
      const manifestBlob = new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'});
      const manifestUrl = URL.createObjectURL(manifestBlob);
      const link = document.getElementById('pwa-manifest');
      link.setAttribute('href', manifestUrl);
      const apple = document.getElementById('apple-touch');
      apple.setAttribute('href', icon192);

      // 3) Register Service Worker (cache-first for offline)
      if('serviceWorker' in navigator){
        const swCode = `const CACHE='yf-split-v1';
self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./','./index.html'])))});
self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim())});
self.addEventListener('fetch',e=>{const r=e.request;if(r.method!=='GET')return;e.respondWith((async()=>{const c=await caches.match(r);try{const f=await fetch(r);const t=f.clone();caches.open(CACHE).then(C=>C.put(r,t));return f}catch(err){return c||Response.error()}})())});`;
        const swBlob = new Blob([swCode], {type:'text/javascript'});
        const swUrl = URL.createObjectURL(swBlob);
        navigator.serviceWorker.register(swUrl, {scope:'./'}).then(()=>{
          console.log('Service Worker registered');
        }).catch(err=>console.warn('SW register failed', err));
      }

      // 4) Optional install prompt button (shows when eligible)
      let deferredPrompt = null;
      window.addEventListener('beforeinstallprompt', (e)=>{
        e.preventDefault(); deferredPrompt = e;
        let btn = document.getElementById('installBtn');
        if(!btn){
          btn = document.createElement('button');
          btn.id='installBtn'; btn.className='btn acc'; btn.textContent='ติดตั้งเป็นแอป';
          document.querySelector('#formCard .row').prepend(btn);
        }
        btn.onclick = async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); const {outcome}=await deferredPrompt.userChoice; console.log('Install', outcome); deferredPrompt=null; btn.remove(); };
      });

    })();
  </script>
</body>
</html>
